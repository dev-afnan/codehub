<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<style>
body { font-family:sans-serif; max-width:800px; margin:auto; padding:20px; }
h2 { text-align:center; }
#loginPrompt { text-align:center; margin-top:20px; }
#conversationList { margin-top:20px; display:none; }
.conversation { border:1px solid #ccc; border-radius:5px; padding:10px; margin-bottom:10px; cursor:pointer; }
#messages { border:1px solid #ccc; border-radius:5px; padding:10px; height:400px; overflow-y:auto; margin-bottom:20px; display:flex; flex-direction:column; }
.message { margin:5px 0; padding:6px 10px; border-radius:5px; max-width:75%; }
.user { background:#e1f5fe; align-self:flex-start; }
.admin { background:#c8e6c9; align-self:flex-end; margin-left:auto; }
form { display:flex; gap:10px; }
input[type=text] { flex:1; padding:8px; border:1px solid #ccc; border-radius:5px; }
button { padding:8px 16px; cursor:pointer; background:#007bff; border:none; color:#fff; border-radius:5px; }
button:hover { background:#0056b3; }
</style>
</head>
<body>
<h2>Admin Panel</h2>

<div id="loginPrompt">
  <button id="googleLoginBtn">Sign in with Google</button>
</div>

<div id="conversationList"></div>

<div id="conversationArea" style="display:none;">
  <h3>Conversation</h3>
  <div id="messages"></div>
  <form id="replyForm">
    <input type="text" id="replyMessage" placeholder="Type your reply..." required>
    <button type="submit">Send</button>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDxMO7-n_ZXp-axX4wBRV8hsVfRmI-aVcM",
  authDomain: "afnanix-contact-form.firebaseapp.com",
  projectId: "afnanix-contact-form",
  storageBucket: "afnanix-contact-form.firebasestorage.app",
  messagingSenderId: "994386258441",
  appId: "1:994386258441:web:5e1b2b412a3778845da6d8",
  measurementId: "G-1TNH5G7SE4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// Replace this with your actual admin UID from Firebase Authentication
const ADMIN_UID = "ph5bDK8VzAOJzqaQxrEje2Z5eK13";

let currentConvRef = null;

// Render a message
function renderMessage(msg, container) {
  const div = document.createElement("div");
  div.className = "message " + msg.sender;
  div.textContent = `${msg.sender}: ${msg.text}`;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// Show conversation
function showConversation(convId) {
  currentConvRef = doc(db, "conversations", convId);
  document.getElementById("conversationArea").style.display = "block";
  const messagesDiv = document.getElementById("messages");
  messagesDiv.innerHTML = "";

  onSnapshot(currentConvRef, (snap) => {
    if (snap.exists()) {
      messagesDiv.innerHTML = "";
      const data = snap.data();
      if (data.messages && data.messages.length) {
        data.messages.forEach(msg => renderMessage(msg, messagesDiv));
      }
    } else {
      messagesDiv.innerHTML = "<p>Conversation not found.</p>";
    }
  });
}

// Send admin reply
document.getElementById("replyForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  if (!currentConvRef) return;
  const text = document.getElementById("replyMessage").value.trim();
  if (!text) return;

  try {
    await updateDoc(currentConvRef, {
      messages: arrayUnion({
        sender: "admin",
        text,
        timestamp: new Date().toISOString()
      })
    });
    document.getElementById("replyMessage").value = "";
  } catch (err) {
    console.error("Error sending admin message:", err);
    alert("Access denied or Firestore rules prevent this action.");
  }
});

// Load all conversations
async function loadConversations() {
  const convList = document.getElementById("conversationList");
  convList.style.display = "block";
  convList.innerHTML = "";
  try {
    const snapshot = await getDocs(collection(db, "conversations"));
    if (snapshot.empty) {
      convList.innerHTML = "<p>No conversations yet.</p>";
    } else {
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "conversation";
        div.textContent = `${data.name} (${data.topic})`;
        div.addEventListener("click", () => showConversation(docSnap.id));
        convList.appendChild(div);
      });
    }
  } catch (err) {
    console.error("Firestore access denied:", err);
    alert("Access denied. Your account is not allowed to access admin panel.");
    await signOut(auth);
    document.getElementById("loginPrompt").style.display = "block";
    convList.style.display = "none";
  }
}

// Google login button
document.getElementById("googleLoginBtn").addEventListener("click", async () => {
  try {
    const result = await signInWithPopup(auth, provider);
    console.log("Signed-in user UID:", result.user.uid);
    if (result.user.uid !== ADMIN_UID) {
      alert("Access denied. This account is not an admin.");
      await signOut(auth);
      return;
    }
    document.getElementById("loginPrompt").style.display = "none";
    await loadConversations();
  } catch (err) {
    console.error("Login error:", err);
    alert("Login failed. Please try again.");
  }
});

// Handle already signed-in users
onAuthStateChanged(auth, async (user) => {
  if (user) {
    console.log("Signed-in user UID:", user.uid);
    if (user.uid !== ADMIN_UID) {
      alert("Access denied. This account is not an admin.");
      await signOut(auth);
      return;
    }
    document.getElementById("loginPrompt").style.display = "none";
    await loadConversations();
  }
});
</script>
</body>
  </html>
