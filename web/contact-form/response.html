<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conversation</title>
<style>
body { font-family:sans-serif; max-width:700px; margin:auto; padding:20px; }
#messages { border:1px solid #ccc; border-radius:5px; background:#fff; padding:10px; height:400px; overflow-y:auto; margin-bottom:20px; display:flex; flex-direction:column; }
.message { margin:5px 0; padding:6px 10px; border-radius:5px; max-width:75%; }
.user { background:#e1f5fe; align-self:flex-start; }
.admin { background:#c8e6c9; align-self:flex-end; margin-left:auto; }
form { display:flex; gap:10px; }
input[type=text] { flex:1; padding:8px; border:1px solid #ccc; border-radius:5px; }
button { padding:8px 16px; cursor:pointer; background:#007bff; border:none; color:#fff; border-radius:5px; }
button:hover { background:#0056b3; }
</style>
</head>
<body>
<h2>Conversation</h2>
<div id="messages"></div>

<form id="replyForm">
  <input type="text" id="replyMessage" placeholder="Type your message..." required>
  <button type="submit">Send</button>
</form>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, doc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDxMO7-n_ZXp-axX4wBRV8hsVfRmI-aVcM",
  authDomain: "afnanix-contact-form.firebaseapp.com",
  projectId: "afnanix-contact-form",
  storageBucket: "afnanix-contact-form.firebasestorage.app",
  messagingSenderId: "994386258441",
  appId: "1:994386258441:web:5e1b2b412a3778845da6d8",
  measurementId: "G-1TNH5G7SE4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const convId = urlParams.get("id");
if (!convId) {
  alert("Invalid conversation link.");
  throw new Error("No conversation ID in URL");
}

const convRef = doc(db, "conversations", convId);
const messagesDiv = document.getElementById("messages");
const replyForm = document.getElementById("replyForm");
const replyInput = document.getElementById("replyMessage");

function renderMessage(msg) {
  const div = document.createElement("div");
  div.className = "message " + msg.sender;
  div.textContent = `${msg.sender}: ${msg.text}`;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Live updates
onSnapshot(convRef, (snapshot) => {
  if (snapshot.exists()) {
    messagesDiv.innerHTML = "";
    const data = snapshot.data();
    if (data.messages && data.messages.length) {
      data.messages.forEach(msg => renderMessage(msg));
    }
  } else {
    messagesDiv.innerHTML = "<p>Conversation not found.</p>";
  }
});

// Send reply
replyForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const text = replyInput.value.trim();
  if (!text) return;

  try {
    await updateDoc(convRef, {
      messages: arrayUnion({
        sender: "user",
        text,
        timestamp: new Date().toISOString()
      })
    });
    replyInput.value = "";
  } catch (err) {
    console.error("Error sending message:", err);
    alert("Error sending message.");
  }
});
</script>
</body>
</html>
