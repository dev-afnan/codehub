<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conversation</title>
<style>
  body { font-family: sans-serif; max-width:700px; margin:auto; padding:20px; }
  #messages { margin-top:20px; border:1px solid #ccc; padding:10px; border-radius:6px; max-height:400px; overflow-y:auto; }
  .message { margin-bottom:10px; }
  .message.user { color: #333; }
  .message.admin { color: #007bff; font-weight:bold; }
  #msgForm { margin-top:20px; }
  #passwordPrompt { margin-bottom:20px; padding:10px; background:#f0f0f0; border-radius:6px; }
</style>
</head>
<body>
<h2>Conversation</h2>

<div id="passwordPrompt">
  <label for="passwordInput">Enter your conversation password:</label>
  <input type="password" id="passwordInput" required>
  <button id="unlockBtn">Unlock Conversation</button>
</div>

<div id="conversationArea" style="display:none;">
  <div id="messages"></div>
  <form id="msgForm">
    <textarea id="newMsg" rows="4" placeholder="Type your message..." required></textarea>
    <button type="submit">Send</button>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getFirestore, doc, getDoc, updateDoc, arrayUnion, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyDxMO7-n_ZXp-axX4wBRV8hsVfRmI-aVcM",
  authDomain: "afnanix-contact-form.firebaseapp.com",
  projectId: "afnanix-contact-form",
  storageBucket: "afnanix-contact-form.firebasestorage.app",
  messagingSenderId: "994386258441",
  appId: "1:994386258441:web:5e1b2b412a3778845da6d8",
  measurementId: "G-1TNH5G7SE4"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const urlParams = new URLSearchParams(window.location.search);
const convId = urlParams.get("id");

if (!convId) {
  alert("Invalid conversation link.");
  throw new Error("No conversation ID in URL");
}

const convRef = doc(db, "conversations", convId);

const passwordPromptDiv = document.getElementById("passwordPrompt");
const passwordInput = document.getElementById("passwordInput");
const unlockBtn = document.getElementById("unlockBtn");
const conversationArea = document.getElementById("conversationArea");
const messagesDiv = document.getElementById("messages");
const msgForm = document.getElementById("msgForm");
const newMsg = document.getElementById("newMsg");

let enteredPassword = "";

unlockBtn.addEventListener("click", async () => {
  enteredPassword = passwordInput.value.trim();
  if (!enteredPassword) return alert("Please enter your password.");

  try {
    const docSnap = await getDoc(convRef);
    if (!docSnap.exists()) {
      return alert("Conversation does not exist.");
    }

    const data = docSnap.data();
    if (data.password !== enteredPassword) {
      return alert("Incorrect password.");
    }

    // Password correct
    passwordPromptDiv.style.display = "none";
    conversationArea.style.display = "block";

    // Show messages in real time
    onSnapshot(convRef, (snapshot) => {
      const convData = snapshot.data();
      messagesDiv.innerHTML = "";
      convData.messages.forEach(msg => {
        const div = document.createElement("div");
        div.className = "message " + (msg.sender === "user" ? "user" : "admin");
        div.textContent = msg.sender + ": " + msg.text;
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    });

  } catch (err) {
    console.error("Error accessing conversation:", err);
    alert("Error accessing conversation.");
  }
});

msgForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const text = newMsg.value.trim();
  if (!text) return;

  try {
    await updateDoc(convRef, {
      messages: arrayUnion({ sender: "user", text, timestamp: serverTimestamp() }),
      password: enteredPassword  // include password for Firestore rules
    });
    newMsg.value = "";
  } catch (err) {
    console.error("Error sending message:", err);
    alert("Failed to send message. Check password or connection.");
  }
});
</script>
</body>
</html>
